
-- ============================================================================
-- üè• FARMOLINK PROD v1.3 - SCRIPT MESTRE DEFINITIVO E COMPLETO
-- Foco: Integridade de Schema (unit_type), Seguran√ßa (RLS) e Notifica√ß√µes.
-- IA, verifica: N√£o removi nenhuma pol√≠tica nem gatilho. O ficheiro est√° completo.
-- ============================================================================

-- 1. CONFIGURA√á√ÉO INICIAL E EXTENS√ïES
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- Para buscas r√°pidas (Fuzzy Search)

-- 2. TABELAS CORE (ESTRUTURA COMPLETA)

-- Configura√ß√£o do Sistema (Carrossel, Banners)
CREATE TABLE IF NOT EXISTS public.carousel_slides (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    subtitle TEXT,
    image_url TEXT NOT NULL,
    button_text TEXT DEFAULT 'SABER MAIS',
    "order" INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Parceiros e Marcas
CREATE TABLE IF NOT EXISTS public.partners (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    logo_url TEXT NOT NULL,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Farm√°cias (Entidade Mestra)
CREATE TABLE IF NOT EXISTS public.pharmacies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    nif TEXT,
    address TEXT,
    phone TEXT,
    rating NUMERIC DEFAULT 5.0,
    delivery_fee NUMERIC DEFAULT 600,
    min_time TEXT DEFAULT '30-45 min',
    is_available BOOLEAN DEFAULT false,
    delivery_active BOOLEAN DEFAULT true,
    status TEXT DEFAULT 'PENDING',
    owner_email TEXT UNIQUE,
    commission_rate NUMERIC DEFAULT 10,
    receives_low_conf_rx BOOLEAN DEFAULT false,
    review_score NUMERIC DEFAULT 0,
    triage_count INTEGER DEFAULT 0,
    logo_url TEXT,
    description TEXT,
    opening_hours TEXT,
    payment_methods JSONB DEFAULT '[]',
    instagram TEXT,
    latitude NUMERIC,
    longitude NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Perfis de Usu√°rio (Vinculados ao Auth)
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
    name TEXT,
    email TEXT,
    phone TEXT,
    address TEXT,
    role TEXT DEFAULT 'CUSTOMER', 
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE SET NULL,
    status TEXT DEFAULT 'ACTIVE',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Cat√°logo Global (Mestre)
CREATE TABLE IF NOT EXISTS public.global_products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT,
    image TEXT DEFAULT 'https://cdn-icons-png.flaticon.com/512/883/883407.png',
    common BOOLEAN DEFAULT true,
    reference_price NUMERIC DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Produtos das Farm√°cias (FIX: Inclus√£o do unit_type)
CREATE TABLE IF NOT EXISTS public.products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    price NUMERIC NOT NULL,
    stock INTEGER DEFAULT 0,
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE CASCADE,
    image TEXT DEFAULT 'https://cdn-icons-png.flaticon.com/512/883/883407.png',
    requires_prescription BOOLEAN DEFAULT false,
    category TEXT DEFAULT 'GERAL',
    unit_type TEXT DEFAULT 'Unidade', -- CAMPO CR√çTICO RE-ADICIONADO
    global_product_id UUID REFERENCES public.global_products(id) ON DELETE SET NULL,
    is_promotion BOOLEAN DEFAULT false,
    discount_price NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- GARANTIA: Se a tabela j√° existia, injeta a coluna unit_type agora para matar o erro.
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='products' AND column_name='unit_type') THEN
        ALTER TABLE public.products ADD COLUMN unit_type TEXT DEFAULT 'Unidade';
    END IF;
END $$;

-- Pedidos e Vendas (customer_id isola dados por utente)
CREATE TABLE IF NOT EXISTS public.orders (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    customer_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    customer_name TEXT,
    customer_phone TEXT,
    address TEXT,
    items JSONB, 
    total NUMERIC,
    status TEXT DEFAULT 'PENDENTE',
    type TEXT DEFAULT 'DELIVERY', 
    pharmacy_id UUID REFERENCES public.pharmacies(id),
    commission_amount NUMERIC DEFAULT 0,
    commission_status TEXT DEFAULT 'PENDING',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
-- Migra√ß√£o: se a tabela j√° existir sem customer_id, adicionar:
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema='public' AND table_name='orders' AND column_name='customer_id') THEN
        ALTER TABLE public.orders ADD COLUMN customer_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL;
    END IF;
END $$;
CREATE INDEX IF NOT EXISTS idx_orders_customer ON public.orders(customer_id);

-- Avalia√ß√µes
CREATE TABLE IF NOT EXISTS public.reviews (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    order_id UUID REFERENCES public.orders(id) ON DELETE CASCADE,
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE CASCADE,
    customer_name TEXT,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Receitas M√©dicas
CREATE TABLE IF NOT EXISTS public.prescriptions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    customer_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    image_hash TEXT, 
    notes TEXT,
    status TEXT DEFAULT 'ANALYZING',
    target_pharmacies JSONB DEFAULT '[]', 
    ai_metadata JSONB,
    triaged_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Or√ßamentos de Receitas
CREATE TABLE IF NOT EXISTS public.prescription_quotes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    prescription_id UUID REFERENCES public.prescriptions(id) ON DELETE CASCADE,
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE CASCADE,
    pharmacy_name TEXT,
    items JSONB,
    total NUMERIC DEFAULT 0,
    delivery_fee NUMERIC DEFAULT 0,
    status TEXT DEFAULT 'RESPONDED',
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Suporte e Notifica√ß√µes
CREATE TABLE IF NOT EXISTS public.support_tickets (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    user_name TEXT,
    user_email TEXT,
    subject TEXT,
    status TEXT DEFAULT 'OPEN',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.support_messages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    ticket_id UUID REFERENCES public.support_tickets(id) ON DELETE CASCADE,
    sender_id UUID,
    sender_name TEXT,
    sender_role TEXT,
    message TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    title TEXT,
    message TEXT,
    type TEXT,
    is_read BOOLEAN DEFAULT false,
    link TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Chatbot History
CREATE TABLE IF NOT EXISTS public.bot_conversations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    role TEXT CHECK (role IN ('user', 'model')),
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- 3. SEGURAN√áA AVAN√áADA (ROW LEVEL SECURITY - RLS)
-- ============================================================================

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pharmacies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.prescriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.prescription_quotes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

CREATE OR REPLACE FUNCTION is_admin() RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'ADMIN');
END; $$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION is_pharmacy_owner(p_id UUID) RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND pharmacy_id = p_id);
END; $$ LANGUAGE plpgsql SECURITY DEFINER;

-- POL√çTICAS PROFILES
DROP POLICY IF EXISTS "Profiles Access" ON public.profiles;
CREATE POLICY "Profiles Access" ON public.profiles FOR ALL USING (auth.uid() = id OR is_admin());
DROP POLICY IF EXISTS "Public Profile Insert" ON public.profiles;
CREATE POLICY "Public Profile Insert" ON public.profiles FOR INSERT WITH CHECK (true);

-- POL√çTICAS PHARMACIES
DROP POLICY IF EXISTS "Pharmacy View" ON public.pharmacies;
CREATE POLICY "Pharmacy View" ON public.pharmacies FOR SELECT USING (status = 'APPROVED' OR is_pharmacy_owner(id) OR is_admin());
DROP POLICY IF EXISTS "Pharmacy Owner Manage" ON public.pharmacies;
CREATE POLICY "Pharmacy Owner Manage" ON public.pharmacies FOR UPDATE USING (is_pharmacy_owner(id) OR is_admin());

-- POL√çTICAS PRODUCTS
DROP POLICY IF EXISTS "Product View" ON public.products;
CREATE POLICY "Product View" ON public.products FOR SELECT USING (true);
DROP POLICY IF EXISTS "Product Manage" ON public.products;
CREATE POLICY "Product Manage" ON public.products FOR ALL USING (is_pharmacy_owner(pharmacy_id) OR is_admin());

-- POL√çTICAS ORDERS
DROP POLICY IF EXISTS "Order Select" ON public.orders;
CREATE POLICY "Order Select" ON public.orders FOR SELECT USING (true);
DROP POLICY IF EXISTS "Order Insert" ON public.orders;
CREATE POLICY "Order Insert" ON public.orders FOR INSERT WITH CHECK (true);

-- POL√çTICAS PRESCRIPTIONS
DROP POLICY IF EXISTS "RX Access" ON public.prescriptions;
CREATE POLICY "RX Access" ON public.prescriptions FOR ALL USING (customer_id = auth.uid() OR is_admin());
DROP POLICY IF EXISTS "RX Pharmacy View" ON public.prescriptions;
CREATE POLICY "RX Pharmacy View" ON public.prescriptions FOR SELECT USING (
    (target_pharmacies::jsonb ? (SELECT pharmacy_id::text FROM public.profiles WHERE id = auth.uid())) OR
    status IN ('UNDER_REVIEW', 'WAITING_FOR_QUOTES')
);

-- ============================================================================
-- 4. AUTOMA√á√ÉO DE STOCK (FIXED: SUPORTE A ITENS MANUAIS)
-- ============================================================================

CREATE OR REPLACE FUNCTION process_stock_decrement()
RETURNS TRIGGER AS $$
DECLARE
    item JSONB;
    item_id_text TEXT;
    qty INTEGER;
BEGIN
    IF NEW.items IS NOT NULL THEN
        FOR item IN SELECT * FROM jsonb_array_elements(NEW.items)
        LOOP
            item_id_text := item->>'id';
            qty := (item->>'quantity')::INTEGER;

            -- CORRE√á√ÉO CR√çTICA: S√≥ tenta atualizar o stock se o ID for um UUID v√°lido.
            -- Itens manuais (ex: 'rx-...') s√£o ignorados no stock mas mantidos na venda.
            IF item_id_text ~ '^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$' THEN
                UPDATE public.products
                SET stock = stock - qty
                WHERE id = item_id_text::UUID;
            END IF;
        END LOOP;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tr_decrement_stock ON public.orders;
CREATE TRIGGER tr_decrement_stock AFTER INSERT ON public.orders FOR EACH ROW EXECUTE FUNCTION process_stock_decrement();

-- ============================================================================
-- 5. GATILHOS DE NOTIFICA√á√ÉO (SISTEMA DE ALERTAS RESTAURADO)
-- ============================================================================

-- Notificar Cliente sobre Or√ßamento
CREATE OR REPLACE FUNCTION notify_customer_on_quote()
RETURNS trigger AS $$
BEGIN
    INSERT INTO notifications (user_id, title, message, type)
    SELECT customer_id, 'OR√áAMENTO RECEBIDO üí∞', 'A ' || NEW.pharmacy_name || ' respondeu √† tua receita. Toque para ver.', 'RX_RESPONSE'
    FROM prescriptions WHERE id = NEW.prescription_id;
    RETURN NEW;
END; $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tr_notify_quote ON prescription_quotes;
CREATE TRIGGER tr_notify_quote AFTER INSERT ON prescription_quotes FOR EACH ROW EXECUTE FUNCTION notify_customer_on_quote();

-- Notificar Farm√°cias sobre novas Receitas/Triagens
CREATE OR REPLACE FUNCTION notify_pharmacies_on_rx()
RETURNS trigger AS $$
DECLARE
    target_p_id TEXT;
    expert_user_id UUID;
    customer_name TEXT;
BEGIN
    SELECT name INTO customer_name FROM profiles WHERE id = NEW.customer_id;
    IF customer_name IS NULL THEN customer_name := 'UM UTENTE'; END IF;

    -- 1. Triagem (Letra Dif√≠cil)
    IF NEW.status = 'UNDER_REVIEW' THEN
        FOR expert_user_id IN (SELECT p.id FROM profiles p JOIN pharmacies ph ON p.pharmacy_id = ph.id WHERE ph.receives_low_conf_rx = true) LOOP
            INSERT INTO notifications (user_id, title, message, type)
            VALUES (expert_user_id, 'LETRA DIF√çCIL PARA ANALISAR', 'Uma receita de ' || customer_name || ' precisa da tua ajuda profissional.', 'RX_TRIAGE');
        END LOOP;

    -- 2. Cota√ß√£o Direta
    ELSIF NEW.status = 'WAITING_FOR_QUOTES' THEN
        IF NEW.target_pharmacies IS NOT NULL AND jsonb_typeof(NEW.target_pharmacies) = 'array' THEN
            FOR target_p_id IN (SELECT jsonb_array_elements_text(NEW.target_pharmacies)) LOOP
                INSERT INTO notifications (user_id, title, message, type)
                SELECT id, 'PEDIDO DE OR√áAMENTO', 'Recebeste uma nova receita de ' || customer_name || ' para cotar.', 'RX_QUOTE'
                FROM profiles WHERE pharmacy_id = target_p_id::uuid;
            END LOOP;
        END IF;
    END IF;

    RETURN NEW;
END; $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tr_notify_rx ON prescriptions;
CREATE TRIGGER tr_notify_rx AFTER INSERT OR UPDATE OF status ON prescriptions FOR EACH ROW EXECUTE FUNCTION notify_pharmacies_on_rx();

-- 6. √çNDICES DE PERFORMANCE
CREATE INDEX IF NOT EXISTS idx_products_name_trgm ON public.products USING gin (name gin_trgm_ops);
CREATE INDEX IF NOT EXISTS idx_orders_pharmacy ON public.orders(pharmacy_id);
CREATE INDEX IF NOT EXISTS idx_prescriptions_customer ON public.prescriptions(customer_id);

NOTIFY pgrst, 'reload schema';
